name: Build and Release

on:
  push:
    branches: [main]
  pull_request:

jobs:
  build-csharp:
    name: Build C# Projects
    runs-on: ubuntu-latest
    strategy:
      matrix:
        project:
          - csharp/adapter_pattern/AdapterPatternApp/AdapterPatternApp.csproj
          - csharp/decorator_pattern/DecoratorPatternApp/DecoratorPatternApp.csproj
          - csharp/facade_pattern/FacadePatternApp/FacadePatternApp.csproj
          - csharp/method_chaining_pattern/MethodChainingPatternApp/MethodChainingPatternApp.csproj
          - csharp/method_chaining_pattern/builder_pattern/BuilderPatternApp/BuilderPatternApp.csproj

    steps:
      - uses: actions/checkout@v3

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Build C# Project
        run: |
          dotnet build ${{ matrix.project }} --configuration Release
          project_dir=$(dirname ${{ matrix.project }})
          mkdir -p build_outputs/csharp/$(basename $project_dir)
          cp -r $project_dir/bin/Release/* build_outputs/csharp/$(basename $project_dir)/

  build-cpp:
    name: Build C++ Projects
    runs-on: ubuntu-latest
    strategy:
      matrix:
        project:
          - cpp/adapter_pattern
          - cpp/decorator_pattern
          - cpp/facade_pattern
          - cpp/builder_pattern
          - cpp/method_chaining_pattern/builder_pattern

    steps:
      - uses: actions/checkout@v3

      - name: Install g++
        run: sudo apt-get update && sudo apt-get install -y g++

      - name: Compile C++ Project
        run: |
          mkdir -p build_outputs/cpp/$(basename ${{ matrix.project }})
          g++ ${{ matrix.project }}/*.cpp -o build_outputs/cpp/$(basename ${{ matrix.project }})/app

  build-kotlin:
    name: Build Kotlin Projects
    runs-on: ubuntu-latest
    strategy:
      matrix:
        project:
          - kotlin/adapter_pattern/AdapterPatternApp
          - kotlin/decorator_pattern/DecoratorPatternApp
          - kotlin/facade_pattern/FacadePatternApp
          - kotlin/builder_pattern/BuilderPatternApp
          - kotlin/method_chaining_pattern/builder_pattern/BuilderPatternApp

    steps:
      - uses: actions/checkout@v3

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Build Kotlin Project
        run: |
          cd ${{ matrix.project }}
          ./gradlew build
          cd ../..
          mkdir -p build_outputs/kotlin/$(basename ${{ matrix.project }})
          cp ${{ matrix.project }}/build/libs/*.jar build_outputs/kotlin/$(basename ${{ matrix.project }})/

  release:
    name: Create GitHub Release
    needs: [build-csharp, build-cpp, build-kotlin]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - uses: actions/checkout@v3

      - name: Archive build outputs
        run: zip -r release-artifacts.zip build_outputs

      - name: Upload GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: release-artifacts.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
